<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Extended Accelerometer Data Recorder</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</head>
<body>
<h1>Extended Accelerometer Data Recorder</h1>
<button onclick="startRecording()">Play</button>
<button onclick="stopRecording()">End</button>
<canvas id="accChart"></canvas>

<script>
var recording = false;
var accData = [];
var accChart;

document.addEventListener("DOMContentLoaded", function() {
    var ctx = document.getElementById('accChart').getContext('2d');
    accChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {label: 'X-axis (acceleration)', borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)', data: []},
                {label: 'Y-axis (acceleration)', borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.5)', data: []},
                {label: 'Z-axis (acceleration)', borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.5)', data: []}
            ]
        },
        options: {
            scales: {
                x: {type: 'linear', beginAtZero: true}
            },
            plugins: {
                zoom: {zoom: {wheel: {enabled: true}, pinch: {enabled: true}, mode: 'xy'}, pan: {enabled: true, mode: 'xy'}}
            }
        }
    });
});

function startRecording() {
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(permissionState => {
            if (permissionState === 'granted') {
                recording = true;
                window.addEventListener('devicemotion', motionHandler, false);
            } else {
                console.log("Permission denied.");
            }
        }).catch(console.error);
    } else {
        recording = true;
        window.addEventListener('devicemotion', motionHandler, false);
    }
}

function stopRecording() {
    recording = false;
    window.removeEventListener('devicemotion', motionHandler);
    exportCSVFile(accData);
    accData = []; // Clear the recorded data after exporting
}

function motionHandler(event) {
    if (recording) {
        var acc = event.acceleration;
        var accGrav = event.accelerationIncludingGravity;
        var rotRate = event.rotationRate;
        if (acc && accGrav && rotRate) {
            var dataPoint = {
                time: event.timeStamp,
                x: acc.x,
                y: acc.y,
                z: acc.z,
                xGrav: accGrav.x,
                yGrav: accGrav.y,
                zGrav: accGrav.z,
                alpha: rotRate.alpha,
                beta: rotRate.beta,
                gamma: rotRate.gamma
            };
            accData.push(dataPoint);
            // Update chart data here if needed
        }
    }
}

function addData(chart, label, dataX, dataY, dataZ) {
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(dataX);
    chart.data.datasets[1].data.push(dataY);
    chart.data.datasets[2].data.push(dataZ);
    if (chart.data.labels.length > 500) {  // Manage data point count to avoid overload
        chart.data.labels.shift();
        chart.data.datasets.forEach((dataset) => {
            dataset.data.shift();
        });
    }
    chart.update();
}

function exportCSVFile(items) {
    var csv = 'Time,X,Y,Z,X Grav,Y Grav,Z Grav,Alpha,Beta,Gamma\n';
    items.forEach(function(item) {
        csv += [item.time, item.x, item.y, item.z, item.xGrav, item.yGrav, item.zGrav, item.alpha, item.beta, item.gamma].join(',') + '\n';
    });
    var hiddenElement = document.createElement('a');
    hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
    hiddenElement.target = '_blank';
    hiddenElement.download = 'accelerometer_data.csv';
    hiddenElement.click();
}

</script>

</body>
</html>

